- [一、现象](#%E4%B8%80%E7%8E%B0%E8%B1%A1)
- [二、看门狗 Watchdog 错误描述（9206）](#%E4%BA%8C%E7%9C%8B%E9%97%A8%E7%8B%97-watchdog-%E9%94%99%E8%AF%AF%E6%8F%8F%E8%BF%B09206)
	- [以下是由硬件看门狗触发重启的最常见原因](#%E4%BB%A5%E4%B8%8B%E6%98%AF%E7%94%B1%E7%A1%AC%E4%BB%B6%E7%9C%8B%E9%97%A8%E7%8B%97%E8%A7%A6%E5%8F%91%E9%87%8D%E5%90%AF%E7%9A%84%E6%9C%80%E5%B8%B8%E8%A7%81%E5%8E%9F%E5%9B%A0)
- [三、建议解决方式](#%E4%B8%89%E5%BB%BA%E8%AE%AE%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F)
	- [0. 收集 Logger 与 Profile 信息](#0-%E6%94%B6%E9%9B%86-logger-%E4%B8%8E-profile-%E4%BF%A1%E6%81%AF)
	- [1.Profiler 设置](#1profiler-%E8%AE%BE%E7%BD%AE)
	- [2.应用程序检查](#2%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%A3%80%E6%9F%A5)
	- [3.更换硬件](#3%E6%9B%B4%E6%8D%A2%E7%A1%AC%E4%BB%B6)
	- [4. 更新软件版本，开启备份数据选项](#4-%E6%9B%B4%E6%96%B0%E8%BD%AF%E4%BB%B6%E7%89%88%E6%9C%AC%E5%BC%80%E5%90%AF%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E9%80%89%E9%A1%B9)
- [四、案例总结](#%E5%9B%9B%E6%A1%88%E4%BE%8B%E6%80%BB%E7%BB%93)

# 一、现象

每次看门狗watch dog发生时，永久变量都会丢失。

> 详情可见此章节[018贝加莱的看门狗Watchdog机制说明](../B02_技术_AutomationRuntime/018贝加莱的看门狗Watchdog机制说明.md)

# 二、看门狗 Watchdog 错误描述（9206）

硬件看门狗触发PLC重启

硬件看门狗已经触发了PLC的重启。由硬件看门狗触发的重启是一种难以诊断的错误，通常是由应用程序中的编程错误引起的。

硬件看门狗是一个硬件组件，用于检查 PLC 和运行在其上的软件是否工作。软件周期性地触发硬件看门狗。如果硬件看门狗没有被及时触发，说明 PLC 没有正常工作，通过重启建立一个确定的状态。

不能保证在由硬件看门狗触发的重启过程中，所有的剩存或永久数据都能正确存储。因此，有可能在重启期间重新初始化留存和永久PV，并在记录仪Logger中输入相应的警告。

在硬件看门狗之后，PLC 根据复位后的启动行为的配置启动。成功的启动由记录仪中的以下警告之一来确认。

> - 设置"Warm restart": 9212 Warning: Warm restart after watchdog or manual RESET
> - 设置 "Cold restart": 9211 Warning: Cold restart after watchdog or manual RESET
> - 设置 "Service": 9210 Warning: Stop/Service after watchdog or manual RESET
> - 设置 "Diagnosis": 9214 Warning: Diagnosis after watchdog or manual RESET

## 以下是由硬件看门狗触发重启的最常见原因

- 应用程序中的编程错误导致系统数据被覆盖，从而不能再正常工作。如果应用程序是用C语言编写的，而对地址进行操作的函数（strcpy、memcpy等）被错误地调用，往往会发生这种错误。
- 为任务类配置的堆栈太小。如果应用程序中有许多嵌套的函数调用（如递归），或者在C语言程序中创建大量的数据作为自动变量（即在堆栈中），就会发生这种情况。
    - ![](FILES/9206%20ERR_RST_WATCHDOG/image-20221208163258960.png)
- CPU的硬件有问题，比如卡存在松动。
- 超出硬件允许的使用环境，例如环境温度上限或下限。
- 有严重问题的Automation Runtime版本
- 检查所有电缆、接地和屏蔽。在某些情况下，看门狗可能是由干扰引起的。
- AR中剩余内存过少。需要确保剩余内存在10MB以上。

# 三、建议解决方式

- 由硬件看门狗触发的错误最常见的原因是应用程序的错误。如果错误是可重复的，可以用 Profiler 来确定触发的程序，通过分析剖析器 Profiler，看在硬件看门狗事件发生前最后运行的是哪个程序。

## 0. 收集 Logger 与 Profile 信息

- 先收集现场故障信息，了解以下信息
    - 出现故障频率
    - 影响范围
    - 设备运行环境
    - 系统运行日志 Logger 文件
    - 系统 Profiler
- 具体操作方式可参考以下链接
- [003如何收集现场PLC的故障信息](../C04_现场维运/003如何收集现场PLC的故障信息.md)

## 1.Profiler 设置

- 为了在硬件看门狗触发的重启事件中也能使用剖析器Profiler，剖析器Profiler必须被配置为将数据对象存储在USERRAM中（如果PLC上有的话）。
- ![](FILES/9206%20ERR_RST_WATCHDOG/image-20221208162352384.png)
- 设置为将配置保存到 USRRAM 并将数据保存到 USRRAM
- ![](FILES/9206%20ERR_RST_WATCHDOG/image-20221208162730509.png)
- 增加Profiler的记录条目数量
- ![](FILES/9206%20ERR_RST_WATCHDOG/image-20221208162750667.png)

## 2.应用程序检查

应用程序应检查其功能是否正确。为此，可以实施检查程序和测试，或者通过代码审查检查程序。应特别关注以下程序。

- **C 语言查看地址操作**。一般的 C 程序。与 IEC 程序相反，C 程序中使用了大量的指针和地址。这使得由于错误的编程而导致硬件看门狗触发的重启变得更加容易。
- **检查内存操作函数**。用地址或指针操作的程序。特别是像 strcpy 或 memcpy 这样的函数，如果使用不当，会导致硬件看门狗的重启。
- 处理数组的程序。写入索引过大的数组可能导致硬件看门狗的重启。使用**IECCheck库**可以用来发现IEC程序中的这些类型的错误。
- 由于递归或大型自动变量而需要大量堆栈的程序。对于这些程序，可以**增加堆栈**来检查硬件看门狗触发的重启是否仍然发生。
- 检查设备剩余 **DRAM 内存**是否足够

## 3.更换硬件

- 如果由硬件看门狗触发的重启第一次发生在未改变的应用程序中，并且这些程序已经在现场进行了很好的测试，如果错误只发生在一个PLC上，而没有发生在相同设计的其他PLC上，那么就应该更换该PLC。
- 例如，当系统运行 10 年没有错误，并且软件没有变化，问题则出在硬件上。因此，请更换硬件。

## 4. 更新软件版本，开启备份数据选项

- 将所有软件（AS，AR，Firmware，mapp）更新到最新版本
- 将 AS 项目更新到版本 >= AS/AR 4.8。在此版本中，添加了循环备份剩余数据的选项。这不会修复Watchdog错误，但可以防止剩余数据丢失：
- ![](FILES/9206%20ERR_RST_WATCHDOG/image-20230721154028882.png)

# 四、案例总结

1. PPC 3100 硬件 PCB 板上进水
2. PPC 2100 PLK 卡没插紧，松动导致
3. 内存操作，长度为 -1，例如 ` memset (&xx, 0, -1) `
4. 设备内进了大量铁屑/粉尘
5. 使用了错误的 mapp 版本，AR 版本
